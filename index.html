<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©ºç©ºå†°ç®± - æ™ºèƒ½å¨æˆ¿</title>
    <style>
        :root { 
            --primary: #ffb900; 
            --bg: #fffaf0; 
            --text: #5d4037; 
            --card-bg: rgba(255, 255, 255, 0.95);
        }

        body { 
            font-family: 'PingFang SC', sans-serif; 
            background-color: var(--bg); 
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='10' y='30' font-size='20'%3EğŸ…%3C/text%3E%3Ctext x='40' y='50' font-size='20'%3EğŸ³%3C/text%3E%3C/svg%3E");
            margin: 0; display: flex; justify-content: center; min-height: 100vh; 
        }

        .container { width: 90%; max-width: 450px; padding: 40px 10px; text-align: center; }

        /* è¾“å…¥åŒº */
        textarea { 
            width: 100%; padding: 20px; border: 2px solid #ffe082; border-radius: 20px; 
            background: #fffdf7; font-size: 16px; outline: none; transition: 0.3s; box-sizing: border-box;
            color: var(--text);
        }

        .btn-group { margin-top: 20px; display: flex; gap: 10px; flex-direction: column; }
        
        button { 
            padding: 16px; border-radius: 50px; border: none; font-weight: bold; 
            cursor: pointer; transition: 0.3s; font-size: 16px; width: 100%;
        }

        .btn-main { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(255,185,0,0.3); }
        .btn-main:hover { transform: translateY(-2px); background: #ffa000; }

        /* ç»“æœæ‚¬æµ®å¡ç‰‡ */
        #recipe-card { 
            display: none; margin-top: 30px; background: var(--card-bg); border-radius: 24px; 
            overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            animation: slideUp 0.5s ease; border: 1px solid #ffecb3;
        }

        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .recipe-img { width: 100%; height: 220px; object-fit: cover; background: #fdf2d2; }
        
        .recipe-content { padding: 20px; text-align: left; }
        
        .recipe-header { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #f0f0f0; padding-bottom: 10px;
        }

        .recipe-title { font-size: 20px; font-weight: bold; color: var(--text); }
        
        .toggle-btn { 
            background: #fff3e0; color: var(--primary); border-radius: 50%; 
            width: 32px; height: 32px; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; font-size: 12px; transition: 0.3s;
        }

        /* éšè—çš„åšæ³•è¯¦æƒ… */
        #recipe-detail { 
            max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;
            color: #6d4c41; font-size: 15px; line-height: 1.8;
        }

        #recipe-detail.show { max-height: 1000px; margin-top: 15px; padding-top: 5px; }

        .retry-area { margin-top: 20px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .btn-secondary { background: #fff; color: #e67e22; border: 1px solid #ffe0b2; font-size: 14px; padding: 10px; }

        .loading { display: none; margin-top: 20px; color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›’ ç©ºç©ºå†°ç®± </h1>
        <textarea id="ingredients" rows="3" placeholder="ä»Šå¤©åƒç‚¹ä»€ä¹ˆå‘¢..."></textarea>
        
        <div class="btn-group">
            <button class="btn-main" onclick="startCooking()">å¼€å§‹åŠ å·¥ï¼</button>
        </div>

        <div id="loading" class="loading">ğŸ‘©â€ğŸ³ åœ¨æƒ³äº†åœ¨æƒ³äº†...</div>

        <div id="recipe-card">
            <img id="recipe-img" class="recipe-img" src="" alt="èœå“å›¾ç‰‡">
            <div class="recipe-content">
                <div class="recipe-header">
                    <span id="title-text" class="recipe-title"></span>
                    <div id="arrow" class="toggle-btn" onclick="toggleDetails()">â–¼</div>
                </div>
                
                <div id="recipe-detail">
                    <div id="steps-content"></div>
                    <div class="retry-area">
                        <button class="btn-secondary" onclick="generateAI()">ä¸æ»¡æ„ï¼Ÿäº¤ç»™ AI</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. æœ¬åœ°é£Ÿè°±åº“ï¼šä½ å¯ä»¥æ ¹æ® images æ–‡ä»¶å¤¹é‡Œçš„å›¾ç‰‡åæ›´æ–° img è·¯å¾„
        // è¿™é‡Œçš„å…³é”®è¯ ingredients ç”¨äºåŒ¹é…ç”¨æˆ·çš„è¾“å…¥
        const localRecipes = [
            { 
                name: "èŠ±æ¤’é¸¡è…¿", 
                keywords: ["èŠ±æ¤’", "é¸¡è…¿", "ç”Ÿå§œ"], 
                steps: "ã€ä¸»æ–™ã€‘é¸¡è…¿1ä¸ªã€èŠ±æ¤’ã€ç”Ÿå§œã€è‘±è‹¥å¹²\nã€æ­¥éª¤ã€‘\n1. å°†èŠ±æ¤’ã€ç”Ÿå§œã€è‘±ã€ç›æ´’åœ¨é¸¡è…¿ä¸Šï¼Œå……åˆ†æŒ‰æ‘©ã€‚\n2. é¸¡è…¿ç”¨ä¿é²œè†œæ”¾å…¥å†°ç®±å†·è—ä¸€å¤œï¼Œè¿›è¡Œè…Œåˆ¶ã€‚\n3. è§†é¸¡è…¿å¤§å°è’¸15-20åˆ†é’Ÿå³å¯å‡ºé”…ï¼Œæˆ–æ”¾å…¥çƒ¤ç®±180åº¦20-25åˆ†é’Ÿå³å¯å‡ºé”…ã€‚", 
                img: "./images/chicken-leg.jpg" 
            },
            { 
                name: "è›‹åŒ…éº»ç³", 
                keywords: ["é¸¡è›‹", "ç³ç²‘", "éº»ç³"], 
                steps: "ã€ä¸»æ–™ã€‘é¸¡è›‹2ä¸ªï¼Œéº»ç³1å—ï¼ˆæ‰‹æŒå¿ƒå¤§å°ï¼‰\nã€æ­¥éª¤ã€‘\n1. è›‹æ¶²åŠ å…¥è‘±èŠ±å’Œå°‘é‡ç›æ‰“æ•£ã€‚\n2. å›½å†…å–·2æ¬¡æ²¹ï¼Œæ”¾å…¥éº»ç³æ…¢æ…¢ç…è½¯ã€‚\n3. éº»ç³ç››å‡ºæ¥ï¼Œå›½å†…å–·1æ¬¡æ²¹ï¼Œå€’å…¥åŠä»½è›‹æ¶²åœ¨é”…ä¸­é“ºå¼€ï¼Œåœ¨è›‹æ¶²æ²¡æœ‰å‡å›ºæ—¶ï¼ŒåŠ å…¥éº»ç³ï¼Œå°†è›‹æ¶²è£¹åœ¨éº»ç³ä¸Šã€‚\n4. éº»ç³ç››å‡ºæ¥ï¼Œå›½å†…å–·1æ¬¡æ²¹ï¼Œå€’å…¥å¦å¤–åŠä»½è›‹æ¶²åœ¨é”…ä¸­é“ºå¼€ï¼ŒåŠ å…¥éº»ç³ï¼Œå°†è›‹æ¶²è£¹åœ¨éº»ç³å¦ä¸€è¾¹ã€‚ç…å¥½å³å¯å‡ºé”…", 
                img: "./images/glutinous-rice-egg.jpg" 
            }
        ];

        let isAiMode = false;

        // æ ¸å¿ƒå…¥å£ï¼šå…ˆæ‰¾æœ¬åœ°ï¼Œæ‰¾ä¸åˆ°å†æ‰¾ AI
        function startCooking() {
            const input = document.getElementById('ingredients').value.trim();
            if (!input) return alert("è¯·å…ˆè¾“å…¥é£Ÿæå“¦ï¼");

            // æœç´¢æœ¬åœ°
            const found = localRecipes.find(recipe => 
                recipe.keywords.some(k => input.includes(k))
            );

            if (found) {
                isAiMode = false;
                showCard(found.name, found.steps, found.img);
            } else {
                generateAI(); // æœ¬åœ°æ²¡æ‰¾åˆ°ï¼Œè‡ªåŠ¨åˆ‡æ¢ AI
            }
        }

        // æ˜¾ç¤ºå¡ç‰‡
        function showCard(title, steps, imgSrc) {
    // 1. è·å–å›¾ç‰‡å…ƒç´ 
    const imgElement = document.getElementById('recipe-img');
    const detail = document.getElementById('recipe-detail');
    const arrow = document.getElementById('arrow');
    
    // 2. é€»è¾‘ï¼šå¦‚æœ imgSrc ä¸ºç©ºï¼ˆæ¯”å¦‚ AI æ¨¡å¼ï¼‰ï¼Œå¼ºåˆ¶æŒ‡å‘ç»å¯¹æ ¹è·¯å¾„çš„é»˜è®¤å›¾
    // æ³¨æ„ï¼šè¿™é‡Œå»æ‰äº† ./ ç›´æ¥ä» / å¼€å§‹
    const finalImgPath = imgSrc ? imgSrc : "/images/default-chef.jpg";
    
    console.log("å°è¯•åŠ è½½çš„æœ€ç»ˆè·¯å¾„æ˜¯:", finalImgPath); // è°ƒè¯•ç”¨ï¼šæŒ‰ä¸‹ F12 å¯ä»¥çœ‹åˆ°è·¯å¾„

    // 3. èµ‹å€¼ç»™å›¾ç‰‡æ ‡ç­¾
    imgElement.src = finalImgPath;
    
    // 4. æ›´æ–°æ–‡å­—å’ŒçŠ¶æ€
    document.getElementById('recipe-card').style.display = 'block';
    document.getElementById('title-text').innerText = title;
    document.getElementById('steps-content').innerText = steps;
    
    // 5. åˆå§‹çŠ¶æ€ä¸ºæŠ˜å 
    detail.classList.remove('show');
    arrow.innerText = "â–¼";

    // 6. è‡ªåŠ¨æ»šåŠ¨åˆ°ç»“æœåŒºï¼Œæå‡ä½“éªŒ
    document.getElementById('recipe-card').scrollIntoView({ behavior: 'smooth' });
}

        // æŠ˜å æ§åˆ¶
        function toggleDetails() {
            const detail = document.getElementById('recipe-detail');
            const arrow = document.getElementById('arrow');
            if (detail.classList.contains('show')) {
                detail.classList.remove('show');
                arrow.innerText = "â–¼";
            } else {
                detail.classList.add('show');
                arrow.innerText = "â–²";
            }
        }

        // AI ç”Ÿæˆé€»è¾‘ï¼ˆè°ƒç”¨ä½ ä¹‹å‰çš„ /api/chat ä¸­è½¬ç«™ï¼‰
        async function generateAI() {
            const input = document.getElementById('ingredients').value;
            const loading = document.getElementById('loading');
            
            loading.style.display = 'block';
            document.getElementById('recipe-card').style.display = 'none';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { 
                                role: "system", 
                                content: "ä½ æ˜¯ä¸€ä½ç²¾é€šâ€˜æ¸…å†°ç®±â€™çš„æš–å¿ƒå¤§å¨ã€‚è¯·æ ¹æ®é£Ÿæç»™å‡ºä¸€ä¸ªèœè°±ã€‚è¿”å›æ ¼å¼å¿…é¡»ä¸¥æ ¼ä¸ºï¼šèœå: [åå­—] | åšæ³•: [æ­¥éª¤ï¼Œä½¿ç”¨1.2.3.åºå·åˆ†è¡Œ]" 
                            },
                            { 
                                role: "user", 
                                content: `æˆ‘æœ‰ï¼š${input}ã€‚è¯·ç»™å‡ºä¸€ä¸ªåˆ›æ„èœè°±ï¼Œé¿å¼€æœ€æ™®é€šçš„åšæ³•ã€‚` 
                            }
                        ]
                    })
                });

                const data = await response.json();
                const content = data.choices[0].message.content;

                // è§£æ AI ç»“æœ
                const [titlePart, stepsPart] = content.split('|');
                const title = titlePart.replace('èœå:', '').trim();
                const steps = stepsPart.replace('åšæ³•:', '').trim();

                isAiMode = true;
                showCard(title, steps, null); // ä½¿ç”¨ä¸€å¼ å›ºå®šçš„â€œAI åˆ›æ„â€æœ¬åœ°å›¾
            } catch (error) {
                alert("å¤§å¨æ²¡æƒ³å¥½...");
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
