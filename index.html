<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ›’ ç©ºç©ºå†°ç®± Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --dark-green: #132a13; --forest: #31572c; --leaf: #90a955; 
            --pale-leaf: #ecf39e; --bg-creme: #fffaf0; --white-glass: rgba(255, 255, 255, 0.8);
        }

        body { 
            font-family: 'Noto Sans SC', sans-serif; background-color: var(--bg-creme);
            background: linear-gradient(rgba(255, 250, 240, 0.9), rgba(255, 250, 240, 0.9)), 
                        url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='10' y='30' font-size='24'%3EğŸ¥¦%3C/text%3E%3Ctext x='60' y='70' font-size='24'%3EğŸ¥•%3C/text%3E%3C/svg%3E");
            margin: 0; padding: 0; color: var(--dark-green); overflow-x: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆªå†…å®¹åŒº */
        .page { display: none; padding: 40px 20px 100px 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 80px;
            background: var(--white-glass); backdrop-filter: blur(15px);
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid rgba(49, 87, 44, 0.1); z-index: 1000;
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; 
            cursor: pointer; color: var(--forest); opacity: 0.5; transition: 0.3s;
        }
        .nav-item.active { opacity: 1; transform: translateY(-5px); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }
        .nav-text { font-size: 12px; font-weight: bold; }

        /* æŒ‰é’®ä¸å¡ç‰‡é£æ ¼ */
        h1 { font-family: 'ZCOOL XiaoWei', serif; font-size: 32px; text-align: center; }
        textarea { 
            width: 100%; padding: 20px; border: 3px solid var(--leaf); border-radius: 25px; 
            background: white; font-size: 16px; outline: none; box-sizing: border-box;
            box-shadow: 0 6px 0 var(--leaf);
        }
        .btn-main { 
            background: var(--forest); color: white; border: none; padding: 15px; width: 100%;
            border-radius: 50px; margin-top: 25px; font-weight: bold; box-shadow: 0 6px 0 var(--dark-green);
        }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 2px 0 var(--dark-green); }

        /* ç»“æœå…¨å±è¦†ç›–å±‚ */
        #result-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-creme); z-index: 2000; display: none; overflow-y: auto;
            padding: 40px 20px; box-sizing: border-box; animation: slideUp 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .close-btn { position: fixed; top: 20px; right: 20px; font-size: 30px; cursor: pointer; z-index: 2100; }

        /* èœè°±å¡ç‰‡ */
        .recipe-card {
            background: white; border-radius: 30px; overflow: hidden; margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative;
        }
        .recipe-img { width: 100%; height: 200px; object-fit: cover; }
        .recipe-info { padding: 20px; }
        .recipe-title { font-family: 'ZCOOL XiaoWei', serif; font-size: 24px; margin-bottom: 10px; }
        .recipe-steps { font-size: 14px; line-height: 1.6; color: #555; white-space: pre-wrap; display: none; }
        .recipe-steps.show { display: block; }
        
        .fav-btn {
            position: absolute; bottom: 20px; right: 20px; font-size: 24px;
            background: var(--pale-leaf); width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        .loading { display: none; text-align: center; margin: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="search-page" class="page active">
        <h1>ğŸ›’ ç©ºç©ºå†°ç®±</h1>
        <textarea id="ingredients" rows="3" placeholder="ä»Šå¤©å†°ç®±é‡Œå‰©ä»€ä¹ˆï¼Ÿ"></textarea>
        <button class="btn-main" onclick="processCooking()">å¼€å§‹åŠ å·¥ï¼</button>
        <div id="loading" class="loading">ğŸ‘¨â€ğŸ³ æ€è€ƒä¸­...</div>
    </div>

    <div id="random-page" class="page">
        <h1>ğŸ² çµæ„Ÿç›²ç›’</h1>
        <p style="text-align:center">ä¸çŸ¥é“åƒä»€ä¹ˆï¼Ÿæ‘‡ä¸€ä¸ªï¼</p>
        <button class="btn-main" onclick="getLucky()">è¯•è¯•æ‰‹æ°”</button>
        <div id="random-result" style="margin-top:20px"></div>
    </div>

    <div id="fav-page" class="page">
        <h1>â­ æˆ‘çš„ç§æˆ¿èœ</h1>
        <div id="fav-list"></div>
    </div>

    <div id="result-overlay">
        <div class="close-btn" onclick="closeOverlay()">Ã—</div>
        <div id="result-content"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('search-page', this)">
            <div class="nav-icon">ğŸ”</div><div class="nav-text">æ‰¾çµæ„Ÿ</div>
        </div>
        <div class="nav-item" onclick="switchPage('random-page', this)">
            <div class="nav-icon">ğŸ²</div><div class="nav-text">ç¢°è¿æ°”</div>
        </div>
        <div class="nav-item" onclick="switchPage('fav-page', this)">
            <div class="nav-icon">â­</div><div class="nav-text">ç§æˆ¿èœ</div>
        </div>
    </div>

    <script>
        const localRecipes = [
            { id: 1, name: "èŠ±æ¤’é¸¡è…¿", keywords: ["èŠ±æ¤’", "é¸¡è…¿"], steps: "1.è…Œåˆ¶2.è’¸ç†Ÿ", img: "/images/chicken-leg.jpg" },
            { id: 2, name: "è›‹åŒ…éº»ç³", keywords: ["é¸¡è›‹", "éº»ç³"], steps: "1.ç…è½¯2.è£¹è›‹", img: "/images/glutinous-rice-egg.jpg" }
        ];

        // é¡µé¢åˆ‡æ¢é€»è¾‘
        function switchPage(pageId, element) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            element.classList.add('active');
            if(pageId === 'fav-page') renderFavs();
        }

        // æ ¸å¿ƒåŠ å·¥é€»è¾‘ï¼šæ”¯æŒå¤šç»“æœå’Œå¼ºåŒ¹é…
        function processCooking() {
            const input = document.getElementById('ingredients').value.trim();
            if(!input) return alert("è¾“å…¥é£Ÿæå‘€ï¼");
            
            // åŒ¹é…é€»è¾‘ï¼šè®¡ç®—åŒ¹é…åˆ°çš„å…³é”®è¯æ•°é‡
            let matches = localRecipes.map(r => {
                let hitCount = r.keywords.filter(k => input.includes(k)).length;
                return { ...r, hitCount };
            }).filter(r => r.hitCount > 0);

            // æ’åºï¼šåŒ¹é…å…³é”®è¯è¶Šå¤šçš„æ’åœ¨è¶Šå‰é¢ï¼ˆå¼ºåŒ¹é…ï¼‰
            matches.sort((a, b) => b.hitCount - a.hitCount);

            if(matches.length > 0) {
                renderResults(matches);
            } else {
                generateAI(input);
            }
        }

        // æ¸²æŸ“æœç´¢ç»“æœï¼ˆè¦†ç›–å½“å‰é¡µï¼‰
        function renderResults(recipes, isAi = false) {
            const container = document.getElementById('result-content');
            container.innerHTML = recipes.map(r => createCardHtml(r, isAi)).join('');
            document.getElementById('result-overlay').style.display = 'block';
        }

        function createCardHtml(r, isAi) {
            const isSaved = getSavedIds().includes(r.id || r.name);
            return `
                <div class="recipe-card">
                    <img class="recipe-img" src="${r.img || '/images/default-chef.jpg'}">
                    <div class="recipe-info">
                        <div class="recipe-title">${r.name}</div>
                        <div class="recipe-steps show">${r.steps}</div>
                        <div class="fav-btn" onclick="toggleSave('${r.name}', '${r.steps}', '${r.img}', this)">
                            ${isSaved ? 'â¤ï¸' : 'â­'}
                        </div>
                    </div>
                </div>
            `;
        }

        // æ”¶è—é€»è¾‘ (LocalStorage)
        function toggleSave(name, steps, img, btn) {
            let favs = JSON.parse(localStorage.getItem('favRecipes') || '[]');
            const index = favs.findIndex(f => f.name === name);
            if(index > -1) {
                favs.splice(index, 1);
                btn.innerText = 'â­';
            } else {
                favs.push({ name, steps, img, id: name });
                btn.innerText = 'â¤ï¸';
            }
            localStorage.setItem('favRecipes', JSON.stringify(favs));
        }

        function getSavedIds() {
            return JSON.parse(localStorage.getItem('favRecipes') || '[]').map(f => f.id);
        }

        function renderFavs() {
            const favs = JSON.parse(localStorage.getItem('favRecipes') || '[]');
            document.getElementById('fav-list').innerHTML = favs.length ? 
                favs.map(r => createCardHtml(r)).join('') : "<p style='text-align:center'>è¿˜æ²¡æ”¶è—è¿‡èœè°±å“¦~</p>";
        }

        // éšæœºæ¨è
        function getLucky() {
            const r = localRecipes[Math.floor(Math.random() * localRecipes.length)];
            document.getElementById('random-result').innerHTML = createCardHtml(r);
        }

        function closeOverlay() { document.getElementById('result-overlay').style.display = 'none'; }

        async function generateAI(input) {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "system", content: "è¿”å›æ ¼å¼ï¼šèœå: [åå­—] | åšæ³•: [æ­¥éª¤]" },
                                   { role: "user", content: `é£Ÿæï¼š${input}ã€‚` }]
                    })
                });
                const data = await response.json();
                const [title, steps] = data.choices[0].message.content.split('|');
                renderResults([{ name: title.replace('èœå:','').trim(), steps: steps.replace('åšæ³•:','').trim() }], true);
            } finally { loading.style.display = 'none'; }
        }
    </script>
</body>
</html>
